<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Agenda Equipe - Studio NBV</title>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <style>
        :root { --primary: #007bff; --bg: #f0f2f5; --nav-height: 60px; }
        body { margin: 0; padding: 0; background: var(--bg); font-family: -apple-system, sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        header { background: #2c3e50; color: white; padding: 15px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { margin: 0; font-size: 1.1rem; text-transform: uppercase; letter-spacing: 1px; }

        /* ABAS */
        .tab-content { display: none; flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 80px; }
        .tab-content.active { display: block; }

        /* NAVBAR */
        .navbar { position: fixed; bottom: 0; width: 100%; height: var(--nav-height); background: white; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #ddd; z-index: 1000; }
        .nav-item { flex: 1; text-align: center; padding: 10px; color: #888; font-size: 0.9rem; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: bold; background: #eef2f6; }
        .nav-icon { font-size: 1.2rem; display: block; margin-bottom: 2px; }

        /* CARDS DA LISTA */
        .event-card { background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 5px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; }
        .event-card h4 { margin: 0 0 5px 0; color: #333; }
        .event-card p { margin: 2px 0; color: #666; font-size: 0.9rem; }
        
        /* Cores dos Cards/Eventos */
        .type-bloqueio { border-left-color: #e74c3c !important; } /* Vermelho */
        .type-atendimento { border-left-color: #f39c12 !important; } /* Amarelo */

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: flex-end; justify-content: center; }
        .modal-overlay.open { display: flex; }
        .modal-content { background: white; width: 100%; max-width: 500px; border-radius: 20px 20px 0 0; padding: 25px; animation: slideUp 0.3s; max-height: 85vh; overflow-y: auto; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .detail-row { margin-bottom: 12px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        .detail-label { font-size: 0.75rem; color: #888; text-transform: uppercase; font-weight: bold; }
        .detail-value { font-size: 1rem; color: #333; word-break: break-word; }
        a.contract-link { color: var(--primary); font-weight: bold; text-decoration: none; display: inline-block; margin-top: 5px; }
    </style>
</head>
<body>

    <header>
        <h1>Agenda da Equipe</h1>
    </header>

    <div id="tab-calendar" class="tab-content active">
        <div id='calendar' style="background:white; padding:10px; border-radius:8px;"></div>
        <div style="margin-top:15px; font-size:0.8rem; text-align:center; display:flex; gap:15px; justify-content:center;">
            <span style="color:#e74c3c">‚óè Bloqueio Total</span>
            <span style="color:#f39c12">‚óè Atendimento</span>
        </div>
    </div>

    <div id="tab-list" class="tab-content">
        <h3 style="margin-top:0; color:#555;">Pr√≥ximos Compromissos</h3>
        <div id="listViewContainer">Carregando...</div>
    </div>

    <nav class="navbar">
        <div class="nav-item active" onclick="switchTab('calendar')">
            <span class="nav-icon">üìÖ</span> Vis√£o Mensal
        </div>
        <div class="nav-item" onclick="switchTab('list')">
            <span class="nav-icon">üìã</span> Lista Pr√≥ximos
        </div>
    </nav>

    <div id="detailsModal" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0; font-size:1.2rem;">Detalhes do Evento</h2>
                <span onclick="closeModal()" style="font-size:2rem; cursor:pointer; line-height:1rem;">&times;</span>
            </div>
            <div id="modalBody"></div>
            <button onclick="closeModal()" style="width:100%; padding:15px; background:#eee; border:none; border-radius:8px; font-weight:bold; margin-top:20px; cursor:pointer;">Fechar</button>
        </div>
    </div>

<script>
    // ======================================================
    // COLE SEU LINK AQUI:
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzjUCPrTr-c_WDZMZNACATAl7zswPbg03XYDk4Vn6kDDUn-LsdJ1hXspNWQNdSVytlVIw/exec';
    // ======================================================

    let allEvents = [];
    let calendar;

    document.addEventListener('DOMContentLoaded', function() {
        initCalendar();
        loadData();
    });

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        
        document.getElementById('tab-' + tabId).classList.add('active');
        
        // Atualiza bot√µes da nav
        const index = tabId === 'calendar' ? 0 : 1;
        document.querySelectorAll('.nav-item')[index].classList.add('active');

        if(tabId === 'calendar' && calendar) calendar.updateSize();
    }

    function initCalendar() {
        calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
            initialView: 'dayGridMonth',
            locale: 'pt-br',
            height: 'auto',
            headerToolbar: { left: 'title', right: 'prev,next' },
            events: allEvents, // Come√ßa vazio, popula depois
            eventClick: function(info) {
                openModal(info.event);
            }
        });
        calendar.render();
    }

    function loadData() {
        fetch(SCRIPT_URL)
        .then(res => res.json())
        .then(data => {
            allEvents = (data.eventos || []).map(ev => {
                // Define cores baseado no tipo
                const isAtendimento = ev.description && ev.description.includes('TIPO: atendimento');
                return {
                    ...ev,
                    color: isAtendimento ? '#f39c12' : '#e74c3c', // Amarelo ou Vermelho
                    classNames: isAtendimento ? ['type-atendimento'] : ['type-bloqueio']
                };
            });
            
            // Atualiza Calend√°rio
            calendar.removeAllEvents();
            calendar.addEventSource(allEvents);
            
            // Atualiza Lista
            renderListView();
        })
        .catch(err => {
            document.getElementById('listViewContainer').innerText = "Erro ao carregar agenda.";
            console.error(err);
        });
    }

    function renderListView() {
        const container = document.getElementById('listViewContainer');
        container.innerHTML = "";
        
        // Ordena por data
        const sorted = [...allEvents].sort((a,b) => new Date(a.start) - new Date(b.start));
        
        if(sorted.length === 0) {
            container.innerHTML = "<p style='text-align:center; color:#999;'>Nenhum evento futuro encontrado.</p>";
            return;
        }

        sorted.forEach(ev => {
            // Verifica data para n√£o mostrar passado na lista
            if(new Date(ev.end) < new Date()) return;

            const div = document.createElement('div');
            // Verifica tipo para classe CSS da borda
            const isAtendimento = ev.description && ev.description.includes('TIPO: atendimento');
            div.className = `event-card ${isAtendimento ? 'type-atendimento' : 'type-bloqueio'}`;
            
            const dateStr = new Date(ev.start).toLocaleDateString('pt-BR', {weekday: 'short', day: '2-digit', month: '2-digit'});
            const timeStr = new Date(ev.start).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
            
            div.innerHTML = `
                <h4>${ev.title}</h4>
                <p>üóìÔ∏è ${dateStr} √†s ${timeStr}</p>
                <p>üìç ${ev.location || 'Local n√£o definido'}</p>
            `;
            
            // Ao clicar na lista, abre o mesmo modal
            div.onclick = () => openModal({
                title: ev.title,
                start: ev.start,
                end: ev.end,
                extendedProps: { description: ev.description, location: ev.location }
            });
            
            container.appendChild(div);
        });
    }

    function openModal(ev) {
        const desc = ev.extendedProps.description || '';
        
        // Extra√ß√£o de dados da descri√ß√£o
        const cliente = (desc.match(/CLIENTE: (.*)/) || [])[1] || '-';
        const whats = (desc.match(/WHATSAPP: (.*)/) || [])[1] || '-';
        const contrato = (desc.match(/CONTRATO: (http[^\s]+)/) || [])[1];
        const obs = (desc.match(/OBS: (.*)/s) || [])[1] || '-';
        const tipo = (desc.match(/TIPO: (.*)/) || [])[1] || 'bloqueio';

        let html = `
            <div class="detail-row"><div class="detail-label">Evento</div><div class="detail-value">${ev.title}</div></div>
            <div class="detail-row"><div class="detail-label">Data/Hora</div><div class="detail-value">${new Date(ev.start).toLocaleString('pt-BR')}</div></div>
            <div class="detail-row"><div class="detail-label">Tipo</div><div class="detail-value" style="color:${tipo==='atendimento'?'#f39c12':'#e74c3c'}; font-weight:bold;">${tipo.toUpperCase()}</div></div>
            <div class="detail-row"><div class="detail-label">Cliente</div><div class="detail-value">${cliente}</div></div>
            <div class="detail-row"><div class="detail-label">Local</div><div class="detail-value">${ev.extendedProps.location || '-'}</div></div>
            <div class="detail-row"><div class="detail-label">WhatsApp</div><div class="detail-value">${whats}</div></div>
            <div class="detail-row"><div class="detail-label">Observa√ß√µes</div><div class="detail-value">${obs}</div></div>
        `;

        if(contrato) {
            html += `<div class="detail-row" style="border:none;"><a href="${contrato}" target="_blank" class="contract-link">üìÑ Ver Contrato / Anexo</a></div>`;
        }

        document.getElementById('modalBody').innerHTML = html;
        document.getElementById('detailsModal').classList.add('open');
    }

    function closeModal() {
        document.getElementById('detailsModal').classList.remove('open');
    }
</script>

</body>
</html>
